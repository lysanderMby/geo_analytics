# Geo Analytics Dashboard Makefile
# Self-hostable brand mention tracking in LLM outputs

.PHONY: help install install-frontend install-backend dev dev-frontend dev-backend build test clean docker-build docker-dev docker-prod check-env setup-db lint format security-check api-docs backup restore

# Default target
help: ## Show this help message
	@echo "Geo Analytics Dashboard - Make Commands"
	@echo "======================================"
	@echo ""
	@awk 'BEGIN {FS = ":.*##"} /^[a-zA-Z_-]+:.*##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""
	@echo "üîí Security Note: API keys are stored encrypted in browser only, never on server"

# Environment setup
check-env: ## Check if all required environment variables are set
	@echo "üîç Checking environment setup..."
	@command -v node >/dev/null 2>&1 || { echo "‚ùå Node.js is required but not installed. Visit https://nodejs.org"; exit 1; }
	@command -v python3 >/dev/null 2>&1 || { echo "‚ùå Python 3.11+ is required but not installed."; exit 1; }
	@command -v poetry >/dev/null 2>&1 || { echo "‚ùå Poetry is required but not installed. Visit https://python-poetry.org"; exit 1; }
	@echo "‚úÖ Environment check passed"

# Installation
install: install-backend install-frontend ## Install all dependencies
	@echo "üéâ Installation complete! Ready to run 'make dev'"

install-backend-prod: ## Install only production backend dependencies
	@echo "üì¶ Installing production backend dependencies..."
	cd backend && poetry install --only main
	@echo "‚úÖ Production backend dependencies installed"

install-frontend: ## Install frontend dependencies
	@echo "üì¶ Installing frontend dependencies..."
	cd frontend && npm install
	@echo "‚úÖ Frontend dependencies installed"

fix-npm-permissions: ## Fix npm cache permissions (if you used sudo npm)
	@echo "üîß Fixing npm cache permissions..."
	sudo chown -R $$(id -u):$$(id -g) "$$HOME/.npm"
	@echo "‚úÖ npm permissions fixed"

install-backend: ## Install backend dependencies
	@echo "üì¶ Installing backend dependencies with Poetry..."
	cd backend && poetry install
	@echo "‚úÖ Backend dependencies installed"

# Development
dev: ## Start development servers (frontend + backend)
	@echo "üöÄ Starting development environment..."
	@echo "Frontend: http://localhost:3000"
	@echo "Backend: http://localhost:8000"
	@echo "API Docs: http://localhost:8000/docs"
	@$(MAKE) -j2 dev-frontend dev-backend

dev-frontend: ## Start frontend development server
	@echo "üé® Starting frontend development server..."
	cd frontend && npm start

dev-backend: ## Start backend development server
	@echo "‚ö° Starting backend development server..."
	cd backend && poetry run uvicorn main:app --reload --host 0.0.0.0 --port 8000

# Build
build: build-frontend build-backend ## Build all components for production
	@echo "üèóÔ∏è Building production artifacts..."

build-frontend: ## Build frontend for production
	@echo "üé® Building frontend..."
	cd frontend && npm run build
	@echo "‚úÖ Frontend built in frontend/build/"

build-backend: ## Prepare backend for production
	@echo "‚ö° Preparing backend for production..."
	cd backend && poetry install --only main && poetry build
	@echo "‚úÖ Backend ready for production"

# Docker
docker-build: ## Build Docker images
	@echo "üê≥ Building Docker images..."
	docker-compose build
	@echo "‚úÖ Docker images built"

docker-dev: ## Start development environment with Docker
	@echo "üê≥ Starting development environment with Docker..."
	@echo "Frontend: http://localhost:3000"
	@echo "Backend: http://localhost:8000"
	docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

docker-prod: ## Start production environment with Docker
	@echo "üê≥ Starting production environment with Docker..."
	docker-compose --profile production up -d
	@echo "‚úÖ Production environment started"

docker-stop: ## Stop Docker containers
	@echo "üõë Stopping Docker containers..."
	docker-compose down

# Database
setup-db: ## Setup database schema (requires Supabase URL in .env)
	@echo "üóÑÔ∏è Setting up database schema..."
	@if [ ! -f backend/.env ]; then \
		echo "‚ùå backend/.env file not found. Copy backend/.env.example and configure it."; \
		exit 1; \
	fi
	@echo "üìã Please run the SQL from database/schema.sql in your Supabase dashboard"
	@echo "üîó Supabase SQL Editor: https://app.supabase.com/project/YOUR_PROJECT/sql"

backup-db: ## Backup database (requires pg_dump)
	@echo "üíæ Creating database backup..."
	@if [ -z "$(DB_URL)" ]; then \
		echo "‚ùå DB_URL environment variable required"; \
		echo "Usage: make backup-db DB_URL=postgresql://..."; \
		exit 1; \
	fi
	@mkdir -p backups
	pg_dump "$(DB_URL)" > backups/backup_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "‚úÖ Database backup created in backups/"

# Code Quality
lint: lint-frontend lint-backend ## Run linting for all components

lint-frontend: ## Lint frontend code
	@echo "üîç Linting frontend..."
	cd frontend && npm run lint --if-present || echo "No lint script found, skipping"

lint-backend: ## Lint backend code
	@echo "üîç Linting backend..."
	cd backend && poetry run flake8 app/ || echo "Skipping flake8 (install with: poetry add --group dev flake8)"

format: format-frontend format-backend ## Format all code

format-frontend: ## Format frontend code
	@echo "‚ú® Formatting frontend..."
	cd frontend && npx prettier --write src/ --ignore-unknown || echo "Prettier not available, skipping"

format-backend: ## Format backend code
	@echo "‚ú® Formatting backend..."
	cd backend && poetry run black . && poetry run isort . || echo "Skipping format (install with: poetry add --group dev black isort)"

# Testing
test: test-frontend test-backend ## Run all tests

test-frontend: ## Run frontend tests
	@echo "üß™ Running frontend tests..."
	cd frontend && npm test --watchAll=false --coverage || echo "No tests found"

test-backend: ## Run backend tests
	@echo "üß™ Running backend tests..."
	cd backend && poetry run pytest || echo "No tests found"

# Security
security-check: ## Run security checks
	@echo "üîí Running security checks..."
	@echo "üîç Checking for exposed API keys..."
	@if grep -r "sk-" --include="*.py" --include="*.js" --include="*.ts" --include="*.json" . 2>/dev/null; then \
		echo "‚ö†Ô∏è Potential API keys found in code! Review immediately."; \
	else \
		echo "‚úÖ No exposed API keys found"; \
	fi
	@echo "üîç Checking for exposed secrets..."
	@if grep -r "secret\|password\|token" --include="*.env*" . 2>/dev/null | grep -v ".env.example"; then \
		echo "‚ö†Ô∏è Potential secrets in env files (expected if configured)"; \
	fi
	cd frontend && npm audit --audit-level=high || echo "npm audit not available"
	cd backend && poetry check || echo "poetry check not available"

# Documentation
api-docs: ## Generate API documentation
	@echo "üìö API Documentation available at:"
	@echo "  Swagger UI: http://localhost:8000/docs"
	@echo "  ReDoc: http://localhost:8000/redoc"
	@echo "Start backend with 'make dev-backend' to access"

# Maintenance
clean: clean-frontend clean-backend ## Clean all build artifacts
	@echo "üßπ Cleaning build artifacts..."

clean-frontend: ## Clean frontend build artifacts
	@echo "üßπ Cleaning frontend..."
	cd frontend && rm -rf build/ node_modules/.cache/
	@echo "‚úÖ Frontend cleaned"

clean-backend: ## Clean backend cache
	@echo "üßπ Cleaning backend..."
	cd backend && find . -type d -name "__pycache__" -exec rm -rf {} + || true
	cd backend && find . -name "*.pyc" -delete || true
	@echo "‚úÖ Backend cleaned"

clean-docker: ## Clean Docker images and containers
	@echo "üê≥ Cleaning Docker resources..."
	docker-compose down --rmi all --volumes --remove-orphans
	@echo "‚úÖ Docker resources cleaned"

# Deployment helpers
deploy-check: ## Pre-deployment checks
	@echo "üöÄ Running pre-deployment checks..."
	@$(MAKE) security-check
	@$(MAKE) build
	@$(MAKE) test
	@echo "‚úÖ Pre-deployment checks passed"

# Quick setup for new developers
quick-setup: check-env install setup-db ## Quick setup for new developers
	@echo ""
	@echo "üéâ Quick setup complete!"
	@echo ""
	@echo "Next steps:"
	@echo "1. Copy backend/.env.example to backend/.env and configure"
	@echo "2. Set up Supabase database with: make setup-db"
	@echo "3. Start development: make dev"
	@echo ""
	@echo "üîí Security reminder: API keys are stored client-side only!"

# Environment file setup
setup-env: ## Create environment files from examples
	@echo "üìù Setting up environment files..."
	@if [ ! -f backend/.env ]; then \
		cp backend/.env.example backend/.env; \
		echo "‚úÖ Created backend/.env - please configure it"; \
	else \
		echo "‚úÖ backend/.env already exists"; \
	fi
	@if [ ! -f frontend/.env.local ]; then \
		echo "REACT_APP_API_URL=http://localhost:8000" > frontend/.env.local; \
		echo "REACT_APP_ENVIRONMENT=development" >> frontend/.env.local; \
		echo "‚úÖ Created frontend/.env.local"; \
	else \
		echo "‚úÖ frontend/.env.local already exists"; \
	fi

# Status check
status: ## Check the status of all services
	@echo "üìä Service Status Check"
	@echo "======================"
	@echo ""
	@echo "Frontend (http://localhost:3000):"
	@curl -s -o /dev/null -w "Status: %{http_code}\n" http://localhost:3000 || echo "‚ùå Not running"
	@echo ""
	@echo "Backend (http://localhost:8000):"
	@curl -s -o /dev/null -w "Status: %{http_code}\n" http://localhost:8000/health || echo "‚ùå Not running"
	@echo ""
	@echo "API Docs: http://localhost:8000/docs"

# Log viewing
logs: ## View Docker logs
	docker-compose logs -f

logs-backend: ## View backend logs only
	docker-compose logs -f backend

logs-frontend: ## View frontend logs only
	docker-compose logs -f frontend

# Poetry-specific commands
poetry-shell: ## Enter Poetry virtual environment
	@echo "üêö Entering Poetry shell..."
	cd backend && poetry shell

poetry-add: ## Add a new backend dependency (usage: make poetry-add PACKAGE=package-name)
	@if [ -z "$(PACKAGE)" ]; then \
		echo "‚ùå Usage: make poetry-add PACKAGE=package-name"; \
		exit 1; \
	fi
	@echo "üì¶ Adding $(PACKAGE) to backend dependencies..."
	cd backend && poetry add $(PACKAGE)

poetry-add-dev: ## Add a new dev dependency (usage: make poetry-add-dev PACKAGE=package-name)
	@if [ -z "$(PACKAGE)" ]; then \
		echo "‚ùå Usage: make poetry-add-dev PACKAGE=package-name"; \
		exit 1; \
	fi
	@echo "üì¶ Adding $(PACKAGE) to backend dev dependencies..."
	cd backend && poetry add --group dev $(PACKAGE)

poetry-update: ## Update all backend dependencies
	@echo "üîÑ Updating backend dependencies..."
	cd backend && poetry update
	@echo "‚úÖ Dependencies updated"

poetry-show: ## Show dependency tree
	@echo "üìã Backend dependency tree:"
	cd backend && poetry show --tree

poetry-export: ## Export requirements.txt from Poetry (for compatibility)
	@echo "üìÑ Exporting requirements.txt..."
	cd backend && poetry export -f requirements.txt --output requirements.txt --without-hashes
	@echo "‚úÖ requirements.txt exported" 